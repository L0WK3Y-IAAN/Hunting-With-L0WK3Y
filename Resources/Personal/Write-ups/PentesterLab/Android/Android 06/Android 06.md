# Android 06

<aside>

## **The Challenge**

This application requires a PIN code to provide you with the key. However, without knowing the PIN, you will not be able to retrieve the key.

There are two ways to get around this:

- The first way is to use [**apktool**](https://ibotpeaches.github.io/Apktool/) like you did before. **`apktool`** will extract the application's code as **`Smali`** code. Then you will be able to browse the source code in the **`Smali`** directory (it's not very intuitive, however, it's enough to solve this exercise).
- The second way is to extract the application yourself using **`unzip`**. From there, you should see a file named **`classes.dex`**. You can then use the tool [**dex2jar**](https://sourceforge.net/projects/dex2jar/) to convert the **`dex`** file to a **`jar`** file. Once this is done, you can either **`unzip`** the **`jar`** file to browse the code or use [**jd-gui**](https://github.com/java-decompiler/jd-gui/releases).

This time the code has been minimised using [**ProGuard**](https://en.wikipedia.org/wiki/ProGuard_(software)). This makes reversing the application more complex.

By inspecting the **`Smali`** code or the **`Java`** code, you should be able to find how the key has been "encrypted". This time, proper encryption is used with **`AES`** in **`CBC`** mode. You can easily retrieve the exercice key by writing a small script to decrypt the ciphertext using the secret key.

</aside>

For challenge 6 there is a Base64 encoded string and another string with `__pentesterlab__` as the key. I will break it down. 

```java
a("The key is: \n" + a.a("ygiG2VpgnW6z2ocCPEVaYhDwBs3UxZENbgh1iQJ6NhpBqHsczQsDh1rD3WjejQ7JH1o+lvBdtxhG64qyLQyHSg", "__pentesterlab__".getBytes()));
```

- Prints "The key is: " followed by the decrypted result
- Calls the decryption method with the encrypted Base64 string and password `"__pentesterlab__"`

## The Decryption Method:

```java
public class a {
    public static String a(String str, byte[] bArr) {
        try {
            byte[] decode = Base64.decode(str, 0);
            byte[] bArr2 = new byte[decode.length];
            byte[] bArr3 = new byte[16];
            System.arraycopy(decode, 0, bArr3, 0, bArr3.length);
            IvParameterSpec ivParameterSpec = new IvParameterSpec(bArr3);
            int length = decode.length - 16;
            byte[] bArr4 = new byte[length];
            System.arraycopy(decode, 16, bArr4, 0, length);
            SecretKeySpec secretKeySpec = new SecretKeySpec(bArr, "AES");
            Cipher cipher = Cipher.getInstance("AES/CBC/PKCS5Padding");
            cipher.init(2, secretKeySpec, ivParameterSpec);
            return new String(cipher.doFinal(bArr4));
        } catch (Exception unused) {
            return "";
        }
    }
}
```

**Line 1-2:** Takes encrypted string and password as input

```java
public static String a(String str, byte[] bArr)
```

**Line 3-4:** Decode the Base64 string into raw bytes

```java
byte[] decode = Base64.decode(str, 0);
```

**Line 5-7:** Extract the first 16 bytes as the IV (Initialization Vector)

```java
byte[] bArr3 = new byte[16];
System.arraycopy(decode, 0, bArr3, 0, bArr3.length);
IvParameterSpec ivParameterSpec = new IvParameterSpec(bArr3);
```

**Line 8-10:** Extract the remaining bytes as the actual encrypted data

```java
int length = decode.length - 16;
byte[] bArr4 = new byte[length];
System.arraycopy(decode, 16, bArr4, 0, length);
```

**Line 11-12:** Set up AES decryption with the password as the key

```java
SecretKeySpec secretKeySpec = new SecretKeySpec(bArr, "AES");
Cipher cipher = Cipher.getInstance("AES/CBC/PKCS5Padding");
```

**Line 13-14:** Decrypt using CBC mode with the IV, then return the plaintext

```java
cipher.init(2, secretKeySpec, ivParameterSpec);
return new String(cipher.doFinal(bArr4));
```

### Quick Rundown

1. Takes a Base64 string containing [IV + encrypted data]
2. Uses the password **`"__pentesterlab__"`** as the AES key
3. Extracts the IV from the first 16 bytes
4. Decrypts the remaining bytes using AES in CBC mode
5. Returns the plaintext string

![image.png](Android%206/image.png)